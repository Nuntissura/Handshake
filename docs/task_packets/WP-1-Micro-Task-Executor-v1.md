# Task Packet: WP-1-Micro-Task-Executor-v1

## METADATA
- TASK_ID: WP-1-Micro-Task-Executor-v1
- WP_ID: WP-1-Micro-Task-Executor-v1
- BASE_WP_ID: WP-1-Micro-Task-Executor
- DATE: 2026-01-22T08:43:59.016Z
- REQUESTOR: User
- AGENT_ID: codex-cli
- ROLE: Orchestrator
- CODER_MODEL: GPT-5.2 (Codex CLI)
- CODER_REASONING_STRENGTH: HIGH
- **Status:** In Progress
- RISK_TIER: HIGH
- USER_SIGNATURE: ilja220120260926

## TECHNICAL_REFINEMENT (MASTER SPEC)
- REFINEMENT_FILE: docs/refinements/WP-1-Micro-Task-Executor-v1.md
- Rule: Task packet creation is blocked until refinement is complete and signed.

## SCOPE
- What: Implement the backend Micro-Task Executor Profile (profile_id=`micro_task_executor_v1`) MVP per Master Spec 2.6.6.8: auto-generate MT definitions from WP scope, execute the MicroTaskExecutionLoop with fresh-context-per-iteration, route validations through the Mechanical Tool Bus (PlannedOperation/EngineResult) with capability checks, persist ProgressArtifact+RunLedger for crash recovery, implement the default escalation chain including HARD_GATE, and emit the required Flight Recorder events including distillation-candidate capture (logging-only; no training).
- Why: Enables deterministic, auditable, crash-recoverable agentic execution for complex work packets using bounded iterations and governance-safe tool invocation (unblocks Phase 1 execution automation and reduces "vibe loop" risk).
- IN_SCOPE_PATHS:
  - src/backend/handshake_core/src/workflows.rs
  - src/backend/handshake_core/src/flight_recorder/mod.rs
  - src/backend/handshake_core/src/flight_recorder/duckdb.rs
  - src/backend/handshake_core/src/ace/mod.rs
  - src/backend/handshake_core/src/mex/runtime.rs
  - src/backend/handshake_core/src/mex/envelope.rs
  - src/backend/handshake_core/mechanical_engines.json
  - src/backend/handshake_core/src/storage/mod.rs
  - src/backend/handshake_core/src/storage/sqlite.rs
  - src/backend/handshake_core/src/storage/postgres.rs
  - src/backend/handshake_core/tests/micro_task_executor_tests.rs (new)
- OUT_OF_SCOPE:
  - Any LoRA training, model promotion, or automated distillation job execution (Phase 2+ only).
  - MT parallel wave execution (Phase 4).
  - Cloud escalation governance/policy (Phase 4).
  - Spec enrichment / spec edits (implement against current anchors).

## WAIVERS GRANTED
- (Record explicit user waivers here per [CX-573F]. Include Waiver ID, Date, Scope, and Justification.)
- NONE

## QUALITY_GATE
### TEST_PLAN
```bash
# Run before handoff:
just pre-work WP-1-Micro-Task-Executor-v1

# Targeted backend tests (add/update as needed):
cargo test --manifest-path src/backend/handshake_core/Cargo.toml

# Governance and workflow gates:
just validator-scan
just validator-spec-regression
just cargo-clean
just post-work WP-1-Micro-Task-Executor-v1
```

### DONE_MEANS
- A WorkflowRun job with `profile_id="micro_task_executor_v1"` executes the Micro-Task Executor path (not the default workflow_run path), and the MT loop starts with FR evidence for: loop_started, iteration_started/complete, validation, escalation/hard_gate, and loop_completed/failed as applicable.
- MT definitions are generated by the system from WP scope (not user-supplied MT definitions); the implementation does not expose an API surface where a user manually provides MT definitions for execution.
- Validation commands are executed via the Mechanical Tool Bus using a PlannedOperation envelope (engine.shell exec), with capability checks, and emit FR-EVT-MT-012 micro_task_validation.
- ProgressArtifact and RunLedger are persisted with idempotency keys and resume_point support; crash recovery restores/marks in_progress steps and resumes from the first pending/failed step.
- Crash recovery emits FR-EVT-WF-RECOVERY (WorkflowRecoveryEvent) with required schema fields (actor=system) and includes enough reason/context to correlate to the recovered MT run.
- Default escalation chain is enforced (7b -> 7b-alt -> 13b -> 13b-alt -> 32b -> HARD_GATE); escalation emits FR-EVT-MT-005 and HARD_GATE emits FR-EVT-MT-006 and pauses execution.
- When `policy.enable_distillation=true` and escalation occurs, the system generates a DistillationCandidate artifact and emits FR-EVT-MT-015; no training occurs in this WP.

### ROLLBACK_HINT
```bash
git revert <commit-sha>
```

## AUTHORITY
- SPEC_BASELINE: Handshake_Master_Spec_v02.115.md (recorded_at: 2026-01-22T08:43:59.016Z)
- SPEC_TARGET: docs/SPEC_CURRENT.md (closure/revalidation target; resolved at validation time)
- SPEC_ANCHOR: Handshake_Master_Spec_v02.115.md 2.6.6.8 (Micro-Task Executor Profile), 2.6.6.8.7.1 (MicroTaskExecutionLoop), 2.6.6.8.8 (Context Compilation), 2.6.6.8.9 (Escalation Chain), 2.6.6.8.10 (Validation Pipeline + CompletionSignal parsing), 2.6.6.8.11 (ProgressArtifact + RunLedger + CrashRecoveryProcedure), 2.6.6.8.12 (FR-EVT-MT-001..017), 2.6.6.8.13 (DistillationCandidate), 6.3 + 11.8 (Mechanical Tool Bus), 11.5.2 (FR-EVT-WF-RECOVERY schema)
- Codex: Handshake Codex v1.4.md
- Task Board: docs/TASK_BOARD.md
- WP Traceability: docs/WP_TRACEABILITY_REGISTRY.md

## LINEAGE_AUDIT (ALL VERSIONS) [CX-580E]
- Prior packet artifacts:
  - docs/task_packets/stubs/WP-1-Micro-Task-Executor-v1.md (stub; not executable)
- Changes in this v1 activation:
  - Activated as an official task packet anchored to SPEC_CURRENT (v02.115) and the signed refinement file.
  - Scope focuses on Phase 1 MVP: MT loop controller + validation wiring + persistence + escalation/hard-gate + distillation candidate capture (no training).

## BOOTSTRAP
- FILES_TO_OPEN:
  - docs/START_HERE.md
  - docs/SPEC_CURRENT.md
  - docs/ARCHITECTURE.md
  - Handshake_Master_Spec_v02.115.md
  - docs/refinements/WP-1-Micro-Task-Executor-v1.md
  - docs/task_packets/stubs/WP-1-Micro-Task-Executor-v1.md
  - src/backend/handshake_core/src/workflows.rs
  - src/backend/handshake_core/src/ace/mod.rs
  - src/backend/handshake_core/src/mex/runtime.rs
  - src/backend/handshake_core/src/mex/envelope.rs
  - src/backend/handshake_core/src/flight_recorder/mod.rs
  - src/backend/handshake_core/src/storage/sqlite.rs
- SEARCH_TERMS:
  - "micro_task_executor_v1"
  - "MicroTaskExecutionLoop"
  - "FR-EVT-MT-"
  - "WorkflowRecovery"
  - "ProgressArtifact"
  - "RunLedger"
  - "CompletionSignal"
  - "planned_operation"
  - "engine.shell"
- RUN_COMMANDS:
  ```bash
  just pre-work WP-1-Micro-Task-Executor-v1
  cargo test --manifest-path src/backend/handshake_core/Cargo.toml
  just post-work WP-1-Micro-Task-Executor-v1
  ```
- RISK_MAP:
  - "infinite loop" -> "executor never terminates; burns iterations/cost"
  - "capability bypass" -> "validations run outside tool bus; no evidence or gates"
  - "anti-gaming failure" -> "model claims completion without evidence; system trusts it"
  - "crash recovery loss" -> "no deterministic resume; repeats or corrupts state"
  - "log/schema drift" -> "FR events emitted but not queryable/traceable in consoles"

## SKELETON
- Proposed interfaces/types/contracts:
  - Dispatch: in `run_job(...)`, route `JobKind::WorkflowRun` + `profile_id == "micro_task_executor_v1"` -> `run_micro_task_executor_v1(state, job, workflow_run_id, trace_id)`; no impact to other profiles.
  - Engine.shell (resolved): register `engine.shell` in `src/backend/handshake_core/mechanical_engines.json` so MEX `G-CAP` does not hard-deny validation ops. The registered op is `exec` with `schema_ref="poe-1.0"` and capability axis `proc.exec` to cover scoped `proc.exec:<tool>` requests.
  - Validation pipeline (Tool Bus): build `PlannedOperation { schema_version:"poe-1.0", engine_id:"engine.shell", operation:"exec", ... }` per verify spec and execute via `MexRuntime` (no direct process execution in workflow code).
  - MT definition generation: MT definitions are ALWAYS auto-generated from WP scope (no API surface for user-supplied MT definitions).
  - Schema coverage commitment: implement Rust types mirroring the spec schemas for `MicroTaskDefinition` (+ MT-VAL-001..010), `ExecutionPolicy`/escalation, `CompletionSignal`, `ValidationExecution/ValidationResult`, `ProgressArtifact`, `RunLedger`, `EscalationRecord`, and `DistillationCandidate`.
  - Hard-gate semantics (resolved): on HARD_GATE triggers (max_total_iterations, max_duration, escalation_exhausted), set phase to paused and await the specified human decision/signal (continue|abort) per the loop algorithm.
  - Flight Recorder (resolved): implement emission for ALL FR-EVT-MT-001..017 when their triggers occur (no "minimum subset" shortcuts).
  - Persistence (resolved): persist `mt_definitions`, `progress_artifact`, `run_ledger`, validation evidence, escalation records, and distillation candidates as artifact files (artifact-first), referenced by `ArtifactHandle`.

- engine.shell registry entry (planned JSON shape):
  ```json
  {
    "engine.shell": {
      "engine_id": "engine.shell",
      "determinism_ceiling": "d1",
      "required_caps": ["fs.read", "fs.write"],
      "required_gates": ["G-SCHEMA", "G-CAP", "G-INTEGRITY", "G-BUDGET", "G-PROVENANCE", "G-DET"],
      "default_budget": { "cpu_time_ms": 60000, "wall_time_ms": 300000, "memory_bytes": 1073741824, "output_bytes": 10485760 },
      "ops": [
        {
          "name": "exec",
          "schema_ref": "poe-1.0",
          "capabilities": ["proc.exec"],
          "output_types": ["artifact.terminal_output"]
        }
      ]
    }
  }
  ```

- Rust type/signature sketch (spec-aligned; serde; before implementation):
  ```rust
  use chrono::{DateTime, Utc};
  use serde::{Deserialize, Serialize};
  use uuid::Uuid;

  use crate::ace::ArtifactHandle;

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct MicroTaskExecutorInputs {
      pub wp_id: String,
      pub wp_scope: WorkPacketScope,
      pub execution_policy: Option<ExecutionPolicy>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct WorkPacketScope {
      pub in_scope_paths: Vec<String>,
      pub out_of_scope: Vec<String>,
      pub done_means: Vec<String>,
      pub test_plan: Vec<String>,
      pub description: String,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct MicroTaskDefinition {
      pub mt_id: String,
      pub name: String,
      pub scope: String,
      pub files: FileAccessSpec,
      pub actions: Vec<String>,
      pub verify: Vec<VerificationSpec>,
      pub done: Vec<DoneCriterion>,
      pub depends_on: Vec<String>,
      pub token_budget: u32,
      pub task_tags: Vec<String>,
      pub risk_level: RiskLevel,
      pub notes: Option<String>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct FileAccessSpec {
      pub read: Vec<String>,
      pub modify: Vec<String>,
      pub create: Vec<String>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub enum VerifyExpect {
      #[serde(rename = "exit_0")]
      Exit0,
      #[serde(rename = "exit_nonzero")]
      ExitNonzero,
      #[serde(rename = "contains")]
      Contains,
      #[serde(rename = "not_contains")]
      NotContains,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct VerificationSpec {
      pub command: String,
      pub expect: VerifyExpect,
      pub pattern: Option<String>,
      pub timeout_ms: u64,
      pub blocking: bool,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub enum DoneVerification {
      #[serde(rename = "automated")]
      Automated,
      #[serde(rename = "evidence_required")]
      EvidenceRequired,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct DoneCriterion {
      pub description: String,
      pub verification: DoneVerification,
      pub verify_ref: Option<usize>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  #[serde(rename_all = "snake_case")]
  pub enum RiskLevel {
      Low,
      Medium,
      High,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct ProgressArtifact {
      pub schema_version: String, // "1.0"
      pub wp_id: String,
      pub job_id: String,
      pub created_at: DateTime<Utc>,
      pub updated_at: DateTime<Utc>,
      pub completed_at: Option<DateTime<Utc>>,
      pub status: ProgressStatus,
      pub policy: ExecutionPolicy,
      pub learning_context: LearningContext,
      pub current_state: CurrentExecutionState,
      pub micro_tasks: Vec<MtProgressEntry>,
      pub aggregate_stats: serde_json::Value, // AggregateStats (referenced but not defined in 2.6.6.8.11.1 excerpt)
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  #[serde(rename_all = "snake_case")]
  pub enum ProgressStatus {
      InProgress,
      Completed,
      CompletedWithIssues,
      Failed,
      Cancelled,
      Paused,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct LearningContext {
      pub skill_bank_snapshot_at_start: DateTime<Utc>,
      pub loras_available: Vec<serde_json::Value>, // LoRAInfo[] (referenced but not defined in 2.6.6.8.11.1 excerpt)
      pub pending_distillation_jobs: u32,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct CurrentExecutionState {
      pub active_mt: Option<String>,
      pub active_model_level: u32,
      pub total_iterations: u32,
      pub total_escalations: u32,
      pub total_drop_backs: u32,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct MtProgressEntry {
      pub mt_id: String,
      pub name: String,
      pub status: MtStatus,
      pub iterations: Vec<IterationRecord>,
      pub final_iteration: Option<u32>,
      pub final_model_level: Option<u32>,
      pub escalation_record_ref: Option<ArtifactHandle>,
      pub summary_ref: Option<ArtifactHandle>,
      pub evidence_refs: Vec<ArtifactHandle>,
      pub distillation_candidate: Option<DistillationProgress>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct DistillationProgress {
      pub eligible: bool,
      pub skill_log_entry_id: Option<String>,
      pub task_type_tags: Vec<String>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  #[serde(rename_all = "snake_case")]
  pub enum MtStatus {
      Pending,
      InProgress,
      Completed,
      Failed,
      Skipped,
      Blocked,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct IterationRecord {
      pub iteration: u32,
      pub model_id: String,
      pub lora_id: Option<String>,
      pub escalation_level: u32,
      pub started_at: DateTime<Utc>,
      pub completed_at: DateTime<Utc>,
      pub duration_ms: u64,
      pub tokens_prompt: u32,
      pub tokens_completion: u32,
      pub claimed_complete: bool,
      pub validation_passed: Option<bool>,
      pub validation_evidence_ref: Option<ArtifactHandle>,
      pub outcome: IterationOutcome,
      pub error_summary: Option<String>,
      pub context_snapshot_id: Uuid,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub enum IterationOutcome {
      #[serde(rename = "SUCCESS")]
      Success,
      #[serde(rename = "RETRY")]
      Retry,
      #[serde(rename = "ESCALATE")]
      Escalate,
      #[serde(rename = "BLOCKED")]
      Blocked,
      #[serde(rename = "SKIPPED")]
      Skipped,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct RunLedger {
      pub ledger_id: Uuid,
      pub wp_id: String,
      pub job_id: String,
      pub created_at: DateTime<Utc>,
      pub steps: Vec<LedgerStep>,
      pub resume_point: Option<String>,
      pub resume_reason: Option<String>,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  pub struct LedgerStep {
      pub step_id: String,
      pub idempotency_key: String,
      pub status: LedgerStatus,
      pub started_at: Option<DateTime<Utc>>,
      pub completed_at: Option<DateTime<Utc>>,
      pub output_artifact_ref: Option<ArtifactHandle>,
      pub error: Option<String>,
      pub recoverable: bool,
  }

  #[derive(Debug, Clone, Serialize, Deserialize)]
  #[serde(rename_all = "snake_case")]
  pub enum LedgerStatus {
      Pending,
      InProgress,
      Completed,
      Failed,
  }

  // ExecutionPolicy / escalation / CompletionSignal / ValidationExecution/Result /
  // EscalationRecord / DistillationCandidate follow the spec schemas and will be persisted as artifacts.
  ```

- MT validation rules enforced (MT-VAL-001..010):
  - MT-VAL-001: `mt_id` unique within the Work Packet (ERROR).
  - MT-VAL-002: `mt_id` matches `MT-[0-9]{3}` (ERROR).
  - MT-VAL-003: all `depends_on` references resolve to existing MT IDs (ERROR).
  - MT-VAL-004: dependency graph is acyclic (ERROR).
  - MT-VAL-005: `files.modify` and `files.create` are within WP `IN_SCOPE_PATHS` (ERROR).
  - MT-VAL-006: `token_budget` does not exceed model context window minus system overhead (ERROR).
  - MT-VAL-007: at least one `verify` spec has `blocking=true` (WARNING).
  - MT-VAL-008: each `done` criterion SHOULD map to a `verify` spec where applicable (WARNING).
  - MT-VAL-009: `actions` list SHOULD be ordered by execution sequence (WARNING).
  - MT-VAL-010: sum of all MT `token_budget` values SHOULD be estimable from WP scope (INFO).
- Open questions:
  - None (spec-critical items resolved in this skeleton update).
- Notes:
  - Implementation will avoid adding any public surface that accepts user-supplied MT definitions; MT definitions are always generated from WP scope.
  - Implementation will not begin until Operator replies with `SKELETON APPROVED`.

## IMPLEMENTATION
- (Coder fills after skeleton approval.)

## HYGIENE
- (Coder fills after implementation; list activities and commands run. Outcomes may be summarized here, but detailed logs should go in ## EVIDENCE.)

## VALIDATION
- (Mechanical manifest for audit. Fill real values to enable 'just post-work'. This section records the 'What' (hashes/lines) for the Validator's 'How/Why' audit. It is NOT a claim of official Validation.)
- If the WP changes multiple non-`docs/` files, repeat the manifest block once per changed file (multiple `**Target File**` entries are supported).
- SHA1 hint: stage your changes and run `just cor701-sha path/to/file` to get deterministic `Pre-SHA1` / `Post-SHA1` values.
- **Target File**: `path/to/file`
- **Start**: <line>
- **End**: <line>
- **Line Delta**: <adds - dels>
- **Pre-SHA1**: `<hash>`
- **Post-SHA1**: `<hash>`
- **Gates Passed**:
  - [ ] anchors_present
  - [ ] window_matches_plan
  - [ ] rails_untouched_outside_window
  - [ ] filename_canonical_and_openable
  - [ ] pre_sha1_captured
  - [ ] post_sha1_captured
  - [ ] line_delta_equals_expected
  - [ ] all_links_resolvable
  - [ ] manifest_written_and_path_returned
  - [ ] current_file_matches_preimage
- **Lint Results**:
- **Artifacts**:
- **Timestamp**:
- **Operator**:
- **Spec Target Resolved**: docs/SPEC_CURRENT.md -> Handshake_Master_Spec_v02.115.md
- **Notes**:

## STATUS_HANDOFF
- (Use this to list touched files and summarize work done without claiming a validation verdict.)
- Current WP_STATUS: In Progress (claimed by CODER / GPT-5.2)
- What changed in this update: SKELETON update - resolved engine.shell registration, full FR-EVT-MT-001..017 commitment, hard-gate semantics per spec, schema-to-Rust mapping sketch
- Next step / handoff hint: Await `SKELETON APPROVED` -> IMPLEMENTATION phase

## EVIDENCE
- (Coder appends logs, test outputs, and proof of work here. No verdicts.)

## VALIDATION_REPORTS
- (Validator appends official audits and verdicts here. Append-only.)
