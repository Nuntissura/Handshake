name: CI

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

env:
  GITLEAKS_VERSION: "8.18.4"
  OSV_SCANNER_VERSION: "1.7.0"
  SYFT_VERSION: "0.105.0"
  SCANCODE_TOOLKIT_VERSION: "32.2.1"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: app/pnpm-lock.yaml

      - name: Enable corepack
        run: corepack enable

      - name: Install frontend deps
        run: pnpm -C app install --frozen-lockfile

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Docs check
        run: |
          test -s .GOV/roles_shared/START_HERE.md
          test -s .GOV/roles_shared/SPEC_CURRENT.md
          test -s .GOV/roles_shared/ARCHITECTURE.md
          test -s .GOV/roles_shared/RUNBOOK_DEBUG.md
          test -s .GOV/roles_shared/PAST_WORK_INDEX.md

      - name: Codex checks
        run: |
          echo "Disallow direct fetch in app/src (outside lib/api.ts)..."
          rg -n "\\bfetch\\s*\\(" app/src | rg -v "app/src/lib/api.ts" && exit 1 || exit 0
          echo "Disallow println!/eprintln! in backend..."
          rg -n "eprintln!|println!" src/backend/handshake_core/src && exit 1 || exit 0
          echo "Hard boundary: product code must not reference .GOV/ ..."
          rg -n "\\.GOV[/\\\\]" app/src src/backend/handshake_core/src src/backend/handshake_core/tests && exit 1 || exit 0
          echo "Docs must not reference legacy Codex versions (v0.5-v0.7)..."
          rg -n "Codex v0\\.5|Codex v0\\.6|Codex v0\\.7|Handshake Codex v0\\.5|Handshake Codex v0\\.6|Handshake Codex v0\\.7" .GOV --glob '!.GOV/task_packets/**' --glob '!.GOV/refinements/**' && exit 1 || exit 0
          rg -n "Codex v0\\.5|Codex v0\\.6|Codex v0\\.7|Handshake Codex v0\\.5|Handshake Codex v0\\.6|Handshake Codex v0\\.7" .GOV/task_packets/README.md && exit 1 || exit 0
          echo "SPEC_CURRENT must reference latest master spec..."
          node .GOV/scripts/spec-current-check.mjs
          echo "Task Board entries must be minimal..."
          node .GOV/scripts/validation/task-board-check.mjs
          echo "In Progress task packets must include coder claim fields..."
          node .GOV/scripts/validation/task-packet-claim-check.mjs
          echo "TODOs must include HSK issue tags..."
          rg -n --pcre2 "TODO(?!\\(HSK-\\d+\\))" app/src src/backend .GOV/scripts --glob "!.GOV/scripts/fixtures/**" --glob "!.GOV/scripts/codex-check-test.mjs" && exit 1 || exit 0

      - name: Git hygiene (build/cache artifacts)
        run: node .GOV/scripts/validation/validator-git-hygiene.mjs

      - name: Codex check tests
        run: node .GOV/scripts/codex-check-test.mjs

      - name: Frontend lint
        run: pnpm -C app run lint

      - name: Frontend architecture (dependency-cruiser)
        run: pnpm -C app run depcruise

      - name: Frontend tests
        run: pnpm -C app test

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust fmt check
        working-directory: src/backend/handshake_core
        run: cargo fmt -- --check

      - name: Rust clippy
        run: cargo clippy --manifest-path src/backend/handshake_core/Cargo.toml --all-targets --all-features

      - name: Rust tests
        run: cargo test --manifest-path src/backend/handshake_core/Cargo.toml

  backend-storage:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        backend: [sqlite, postgres]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: handshake_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d handshake_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Configure SQLite env
        if: matrix.backend == 'sqlite'
        run: echo "DATABASE_URL=sqlite::memory:" >> $GITHUB_ENV

      - name: Configure Postgres env
        if: matrix.backend == 'postgres'
        run: |
          echo "POSTGRES_TEST_URL=postgres://postgres:postgres@localhost:5432/handshake_test" >> $GITHUB_ENV
          echo "DATABASE_URL=postgres://postgres:postgres@localhost:5432/handshake_test" >> $GITHUB_ENV

      - name: Storage conformance tests
        run: cargo test --manifest-path src/backend/handshake_core/Cargo.toml --tests storage_conformance

  secret_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.4"

      - name: Install gitleaks (pinned)
        run: |
          set -euo pipefail
          go install github.com/gitleaks/gitleaks/v8@v${GITLEAKS_VERSION}
          GOPATH_BIN="$(go env GOPATH)/bin"
          echo "$GOPATH_BIN" >> "$GITHUB_PATH"
          export PATH="$GOPATH_BIN:$PATH"
          gitleaks version

      - name: Run supply-chain MEX (secret_scan)
        env:
          HSK_RELEASE_MODE: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: cargo test --manifest-path src/backend/handshake_core/Cargo.toml --test mex_tests ci_secret_scan_runs_via_terminal_service -- --ignored

      - name: Upload supply-chain artifacts + Flight Recorder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mex_supply_chain_secret_scan
          path: data/mex_supply_chain
          if-no-files-found: warn

  vuln_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.4"

      - name: Install osv-scanner (pinned)
        run: |
          set -euo pipefail
          go install github.com/google/osv-scanner/cmd/osv-scanner@v${OSV_SCANNER_VERSION}
          GOPATH_BIN="$(go env GOPATH)/bin"
          echo "$GOPATH_BIN" >> "$GITHUB_PATH"
          export PATH="$GOPATH_BIN:$PATH"
          osv-scanner --version

      - name: Run supply-chain MEX (vuln_scan)
        env:
          HSK_RELEASE_MODE: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: cargo test --manifest-path src/backend/handshake_core/Cargo.toml --test mex_tests ci_vuln_scan_runs_via_terminal_service -- --ignored

      - name: Upload supply-chain artifacts + Flight Recorder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mex_supply_chain_vuln_scan
          path: data/mex_supply_chain
          if-no-files-found: warn

  sbom_generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.4"

      - name: Install syft (pinned)
        run: |
          set -euo pipefail
          go install github.com/anchore/syft/cmd/syft@v${SYFT_VERSION}
          GOPATH_BIN="$(go env GOPATH)/bin"
          echo "$GOPATH_BIN" >> "$GITHUB_PATH"
          export PATH="$GOPATH_BIN:$PATH"
          syft version

      - name: Run supply-chain MEX (sbom_generate)
        env:
          HSK_RELEASE_MODE: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: cargo test --manifest-path src/backend/handshake_core/Cargo.toml --test mex_tests ci_sbom_generate_runs_via_terminal_service -- --ignored

      - name: Upload supply-chain artifacts + Flight Recorder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mex_supply_chain_sbom_generate
          path: data/mex_supply_chain
          if-no-files-found: warn

  license_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install scancode-toolkit (pinned)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install "scancode-toolkit==${SCANCODE_TOOLKIT_VERSION}"
          scancode --version

      - name: Run supply-chain MEX (license_scan)
        env:
          HSK_RELEASE_MODE: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: cargo test --manifest-path src/backend/handshake_core/Cargo.toml --test mex_tests ci_license_scan_runs_via_terminal_service -- --ignored

      - name: Upload supply-chain artifacts + Flight Recorder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mex_supply_chain_license_scan
          path: data/mex_supply_chain
          if-no-files-found: warn

  dependency_audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: app/pnpm-lock.yaml

      - name: Enable corepack
        run: corepack enable

      - name: Install frontend deps
        run: pnpm -C app install --frozen-lockfile

      - name: Frontend audit
        run: pnpm -C app audit --audit-level high

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Rust dependency policy
        run: cargo deny --manifest-path src/backend/handshake_core/Cargo.toml check advisories licenses bans sources

  traceability:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Need commit history for traceability

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Traceability check
        run: node .GOV/scripts/validation/ci-traceability-check.mjs

