#!/usr/bin/env bash
# Pre-commit hook [CX-902]
# Enforces workflow compliance at commit time

set -e

echo ""
GOV_REF_FILE=""
if command -v node >/dev/null 2>&1; then
  GOV_REF_FILE="$(node .GOV/scripts/validation/governance-reference.mjs --print-file 2>/dev/null || true)"
fi

GOV_REF_LABEL="(unresolved; see .GOV/roles_shared/SPEC_CURRENT.md)"
GOV_REF_SEE=".GOV/roles_shared/SPEC_CURRENT.md"
if [ -n "$GOV_REF_FILE" ]; then
  GOV_REF_LABEL="$GOV_REF_FILE"
  GOV_REF_SEE="$GOV_REF_FILE"
fi

echo "Pre-commit validation (Governance Reference: ${GOV_REF_LABEL})..."
echo ""

# Extract WP_ID from commit message (if in env)
# Git hooks don't have direct access to commit message in pre-commit
# So we'll check for staged changes and validate against recent logger entries

# Check 1: Ensure files are staged
STAGED_FILES=$(git diff --cached --name-only)
if [ -z "$STAGED_FILES" ]; then
  echo "Æ’?O No files staged for commit"
  exit 1
fi

echo "Æ’o. Files staged for commit"
echo ""

# Check 2: Clean Cargo artifacts (external target dir to avoid repo bloat)
echo "Cleaning Cargo artifacts (external target dir)..."
if just cargo-clean; then
  echo "Æ’o. Cargo target cleaned at ../Cargo Target/handshake-cargo-target"
else
  echo ""
  echo "Æ’?O Cargo clean failed"
  echo "Ensure cargo is installed and rerun: just cargo-clean"
  exit 1
fi

echo ""

# Check 3: Run codex-check to enforce hard invariants
echo "Running codex-check (hard invariants)..."
if just codex-check; then
  echo "Æ’o. Codex check passed"
else
  echo ""
  echo "Æ’?O Codex check FAILED"
  echo ""
  echo "Fix codex violations before committing."
  echo "See: ${GOV_REF_SEE}"
  exit 1
fi

echo ""

# Check 4: Ensure no placeholder values in staged files
echo "Checking for placeholder values..."
PLACEHOLDERS=$(git diff --cached | grep -E '\{[a-z_]+\}' || true)
if [ -n "$PLACEHOLDERS" ]; then
  echo "Æ’sÃ¿â€¹,?  WARNING: Placeholder values detected in staged changes:"
  echo "$PLACEHOLDERS"
  echo ""
  echo "Ensure all {placeholder} values are replaced with actual values."
  echo "Proceeding with commit (warning only)..."
else
  echo "Æ’o. No placeholders detected"
fi

echo ""

# Check 5: Verify logger has recent entries (traceability)
echo "Checking logger traceability..."
LOGGER_FILES=$(find . -maxdepth 1 -name "Handshake_logger_*.md" | sort -r | head -1)
if [ -z "$LOGGER_FILES" ]; then
  echo "Æ’sÃ¿â€¹,?  WARNING: No logger file found"
  echo "Consider adding a logger entry for traceability."
  echo "Proceeding with commit (warning only)..."
else
  # Check if logger has recent entries (modified in last 24 hours or RESULT field updated)
  LOGGER_MODIFIED=$(stat -c %Y "$LOGGER_FILES" 2>/dev/null || stat -f %m "$LOGGER_FILES" 2>/dev/null || echo "0")
  NOW=$(date +%s)
  AGE=$((NOW - LOGGER_MODIFIED))

  if [ $AGE -gt 86400 ]; then
    echo "Æ’sÃ¿â€¹,?  WARNING: Logger not updated recently (>24h)"
    echo "Consider adding a logger entry for this work."
    echo "Proceeding with commit (warning only)..."
  else
    echo "Æ’o. Logger recently updated"
  fi
fi

echo ""

# Check 6: Lint/format check for staged files
echo "Running quick lint check on staged files..."

# Check if any .rs files are staged
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)
if [ -n "$RUST_FILES" ]; then
  echo "Checking Rust formatting (staged files only)..."
  RUSTFMT_FAILED=0
  while IFS= read -r file; do
    if [ -z "$file" ]; then
      continue
    fi
    if [ ! -f "$file" ]; then
      continue
    fi
    if ! rustfmt --edition 2021 --check "$file"; then
      RUSTFMT_FAILED=1
    fi
  done <<< "$RUST_FILES"

  if [ $RUSTFMT_FAILED -eq 0 ]; then
    echo "Æ’o. Rust staged files formatted"
  else
    echo ""
    echo "Æ’?O Rust staged files not formatted"
    echo "Run: cd src/backend/handshake_core && cargo fmt"
    exit 1
  fi
fi

# Check if any .ts/.tsx/.js/.jsx files are staged
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$TS_FILES" ]; then
  echo "Checking TypeScript/JavaScript linting..."
  if cd app && pnpm run lint --quiet; then
    echo "Æ’o. Frontend files pass lint"
    cd - > /dev/null
  else
    cd - > /dev/null
    echo ""
    echo "Æ’?O Frontend lint failed"
    echo "Run: pnpm -C app run lint"
    exit 1
  fi
fi

echo ""
echo "Æ’o. Pre-commit validation passed"
echo ""
echo "Reminder: For WP handoff, run these at handoff (before or after commit):"
echo "  - just post-work WP-{ID}  (prefers staged changes; clean trees validate HEAD^..HEAD)"
echo "  - just validate  (full hygiene check)"
echo ""

